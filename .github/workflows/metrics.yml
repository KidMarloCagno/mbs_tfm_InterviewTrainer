name: Essential Metrics

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  metrics:
    runs-on: ubuntu-latest
    name: Track TIER 1 Metrics

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.29.3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm prisma generate

      - name: TIER 1 - Test Success Rate
        id: tests
        run: |
          echo "Running tests..."
          pnpm vitest run > test-output.txt 2>&1 || true
          
          # Debug: Show test output
          echo "=== Test Output ==="
          cat test-output.txt
          echo "==================="
          
          # Extract metrics from Vitest output format: "Tests  3 passed | 1 skipped (4)"
          TEST_PASSED=$(grep 'Tests' test-output.txt | grep -oE '[0-9]+ passed' | grep -oE '[0-9]+' || echo "0")
          TEST_FAILED=$(grep 'Tests' test-output.txt | grep -oE '[0-9]+ failed' | grep -oE '[0-9]+' || echo "0")
          TEST_SKIPPED=$(grep 'Tests' test-output.txt | grep -oE '[0-9]+ skipped' | grep -oE '[0-9]+' || echo "0")
          
          # Extract total from parentheses: "(4)"
          TEST_TOTAL=$(grep 'Tests' test-output.txt | grep -oE '\([0-9]+\)' | grep -oE '[0-9]+' || echo "0")
          
          # Fallback: sum passed + failed + skipped if total not found
          if [ "${TEST_TOTAL:-0}" -eq 0 ]; then
            TEST_TOTAL=$((${TEST_PASSED:-0} + ${TEST_FAILED:-0} + ${TEST_SKIPPED:-0}))
          fi
          
          # Ensure we don't divide by zero
          if [ "${TEST_TOTAL:-0}" -eq 0 ]; then
            echo "::error::No tests found in output"
            cat test-output.txt
            exit 1
          fi
          
          TEST_RATE=$((${TEST_PASSED:-0} * 100 / ${TEST_TOTAL:-1}))
          echo "test_rate=$TEST_RATE" >> $GITHUB_OUTPUT
          echo "Test Success Rate: $TEST_RATE% (${TEST_PASSED:-0}/${TEST_TOTAL:-0})"

          if [ "$TEST_RATE" -lt 95 ]; then
            echo "RED FLAG: Test success rate below 95%"
            exit 1
          fi

      - name: TIER 1 - Build Success Rate
        run: |
          echo "Checking TypeScript build..."
          pnpm tsc --noEmit
          echo "Build Success: 100%"

      - name: TIER 1 - Lint Quality
        run: |
          echo "Checking code quality..."
          LINT_ISSUES=$(pnpm lint 2>&1 | grep -c 'problem' || echo "0")
          echo "Lint Issues: $LINT_ISSUES"

          if [ "$LINT_ISSUES" -gt 0 ]; then
            echo "WARNING: $LINT_ISSUES lint issues found"
            exit 1
          fi

      - name: TIER 3 - Technical Debt
        run: |
          echo "Counting technical debt..."
          TODO_COUNT=$(grep -r "TODO" pages components lib store prisma 2>/dev/null | wc -l | xargs)
          echo "Technical Debt: $TODO_COUNT TODOs"

          if [ "$TODO_COUNT" -gt 10 ]; then
            echo "WARNING: High technical debt (>10 TODOs)"
          fi

      - name: Summary
        if: always()
        run: |
          echo "----------------------------------------"
          echo "Essential Metrics Summary"
          echo "----------------------------------------"
          echo "Test Success Rate: OK"
          echo "Build Success: OK"
          echo "Code Quality: OK"
          echo "----------------------------------------"