name: Essential Metrics

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  metrics:
    runs-on: ubuntu-latest
    name: Track TIER 1 Metrics

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: TIER 1 - Test Success Rate
        id: tests
        run: |
          echo "Running tests..."
          pnpm vitest run --reporter=verbose > test-output.txt 2>&1 || true
          
          # Extract test counts with better error handling
          # We want the "Tests" line, not "Test Files", so we filter explicitly and get the final match
          TEST_PASSED=$(grep 'Tests' test-output.txt | grep -oE '[0-9]+ passed' | grep -oE '[0-9]+' | tail -1)
          TEST_PASSED=${TEST_PASSED:-0}
          
          # Try to extract total from the format: "Tests  3 passed | 1 skipped (4)"
          # The number in parentheses is the total
          TEST_TOTAL=$(grep -E 'Tests.*passed' test-output.txt | grep -oE '\([0-9]+\)' | grep -oE '[0-9]+')
          TEST_TOTAL=${TEST_TOTAL:-0}
          
          # If TEST_TOTAL is still 0 or empty, try alternative parsing
          if [ -z "$TEST_TOTAL" ] || [ "$TEST_TOTAL" -eq 0 ]; then
            # Fallback: count passed + failed + skipped
            TEST_FAILED=$(grep 'Tests' test-output.txt | grep -oE '[0-9]+ failed' | grep -oE '[0-9]+' | tail -1)
            TEST_FAILED=${TEST_FAILED:-0}
            TEST_SKIPPED=$(grep 'Tests' test-output.txt | grep -oE '[0-9]+ skipped' | grep -oE '[0-9]+' | tail -1)
            TEST_SKIPPED=${TEST_SKIPPED:-0}
            TEST_TOTAL=$((TEST_PASSED + TEST_FAILED + TEST_SKIPPED))
          fi
          
          # Final safety check to prevent division by zero
          if [ -z "$TEST_TOTAL" ] || [ "$TEST_TOTAL" -eq 0 ]; then
            echo "::error::Could not parse test results. Check test output below:"
            cat test-output.txt
            echo "::warning::Could not parse test results. Defaulting to 1 total."
            TEST_TOTAL=1
          fi
          
          TEST_RATE=$((TEST_PASSED * 100 / TEST_TOTAL))
          echo "test_rate=$TEST_RATE" >> $GITHUB_OUTPUT
          echo "Test Success Rate: $TEST_RATE% ($TEST_PASSED/$TEST_TOTAL)"

          if [ "$TEST_RATE" -lt 95 ]; then
            echo "RED FLAG: Test success rate below 95%"
            exit 1
          fi

      - name: TIER 1 - Build Success Rate
        run: |
          echo "Checking TypeScript build..."
          pnpm tsc --noEmit
          echo "Build Success: 100%"

      - name: TIER 1 - Lint Quality
        run: |
          echo "Checking code quality..."
          LINT_ISSUES=$(pnpm lint 2>&1 | grep -c 'problem' || echo "0")
          echo "Lint Issues: $LINT_ISSUES"

          if [ "$LINT_ISSUES" -gt 0 ]; then
            echo "WARNING: $LINT_ISSUES lint issues found"
            exit 1
          fi

      - name: TIER 3 - Technical Debt
        run: |
          echo "Counting technical debt..."
          TODO_COUNT=$(grep -r "TODO" pages components lib store prisma 2>/dev/null | wc -l | xargs)
          echo "Technical Debt: $TODO_COUNT TODOs"

          if [ "$TODO_COUNT" -gt 10 ]; then
            echo "WARNING: High technical debt (>10 TODOs)"
          fi

      - name: Summary
        if: always()
        run: |
          echo "----------------------------------------"
          echo "Essential Metrics Summary"
          echo "----------------------------------------"
          echo "Test Success Rate: OK"
          echo "Build Success: OK"
          echo "Code Quality: OK"
          echo "----------------------------------------"